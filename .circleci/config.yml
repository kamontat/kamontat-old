version: 2.1

orbs:
  node: circleci/node@2.0.1
  codecov: codecov/codecov@1.0.5
  cypress: cypress-io/cypress@1.19.1

parameters:
  node-version:
    type: string
    default: "12.16"

jobs:
  testing:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - node/install-packages:
          cache-version: v1
          cache-key: yarn.lock
          pkg-manager: yarn
          with-cache: true
          include-branch-in-cache-key: false
      - run:
          name: Testing
          command: yarn test:ci
          environment:
            JEST_JUNIT_OUTPUT_DIR: "reports/junit"
      - codecov/upload:
          conf: .codecov.yml
          flags: unittest
      - store_test_results:
          name: Collect junit reports
          path: reports
      - store_artifacts:
          name: Collect coverage reports
          path: coverage/lcov-report
          destination: coverage

  linting:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - node/install-packages:
          cache-version: v1
          cache-key: yarn.lock
          pkg-manager: yarn
          with-cache: true
          include-branch-in-cache-key: false
      - run:
          name: Execute eslint
          command: yarn lint:ci
      - store_test_results:
          path: reports

workflows:
  testing-and-checking-code-style:
    jobs:
      - testing
      - linting
      - cypress/install:
          yarn: true
          cache-key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
          build: yarn build --verbose
      - cypress/run:
          requires:
            - cypress/install
          start: yarn serve
          wait-on: "http://localhost:9000"
          record: true
          yarn: true
          cache-key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
          store_artifacts: true
          browser: chrome
          post-steps:
            - store_test_results:
                path: reports
